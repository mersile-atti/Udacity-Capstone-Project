version: 2.1

orbs:
  aws-cli: circleci/aws-cli@2.0.3  
  aws-eks: circleci/aws-eks@1.1.0
  kubernetes: circleci/kubernetes@1.3.0
  docker: circleci/docker@2.1.4

jobs:
    lint:
        docker:
            # Use the same Docker base as the project 
          - image: circleci/node:13.8.0
        steps:
            - checkout
            - run:
                name: install dependencies
                command: |
                    # Install hadolint
                    make install
            # run lint!
            - run:
                name: Linting docker file
                command: |
                    make lint 
    build-frontend:
      docker:
        - image: circleci/node:13.8.0
      steps:
        - checkout
        - restore_cache:
            keys: [frontend-build]
        - run:
            name: Build front-end
            command: |
              cd src/frontend
              npx browserslist@latest --update-db
              npm install
              npm run build
              exit 0
        - save_cache:
            paths: [frontend/node_modules]
            key: frontend-build
  
    build-backend:
      docker:
        - image: circleci/node:13.8.0
      steps:
        - checkout
        - restore_cache:
            keys: [backend-build]
        - run:
            name: Back-end build
            command: |
              cd src/backend
              npm install
              exit 0
        - save_cache:
            paths: [backend/node_modules]
            key: backend-build
    test-backend:
      docker:
        - image: circleci/node:13.8.0
      steps:
        - checkout
        - restore_cache:
            keys: [backend-test]
        - run:
            name: Run backend test
            command: |
              cd src/backend
              npm install
              npm run test
              exit 0
  
    scan-frontend:
      docker:
        - image: circleci/node:13.8.0
      steps:
        - checkout
        - restore_cache:
            keys: [frontend-scan]
        - run:
            name: Scan frontend dependencies
            command: |
              cd src/frontend
              npm install
              npm audit fix --audit-level=critical --force


    scan-backend:
      docker:
        - image: circleci/node:13.8.0
      steps:
        - checkout
        - restore_cache:
            keys: [backend-scan]
        - run:
            name: Scan backend dependencies
            command: |
              cd src/backend
              npm install
              npm audit fix --audit-level=critical --force
 
workflows:
  default:
    jobs:
      - docker/hadolint:
          dockerfiles: './Dockerfile'
          ignore-rules: 'DL4005,DL3008'
          trusted-registries: 'docker.io,my-company.com:5000'
      - build-frontend
      - build-backend
      - test-frontend:
          requires: [build-frontend]
      - test-backend:
          requires: [build-backend]
      - scan-frontend:
          requires: [build-frontend]
      - scan-backend:
          requires: [build-backend]